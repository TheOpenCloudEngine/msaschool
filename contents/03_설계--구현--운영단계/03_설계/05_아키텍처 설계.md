## 아키텍처 설계

### Inner 아키텍처 

아래와 같은 육각형 모형의 아키텍처를 헥사고날 아키텍처라고 합니다. 
이는 가운데 영역인 비지니스 로직 (도메인 영역)을 손상시키지 않고 프로그램을 구성하도록 고안된 아키텍처입니다. 

예를 들어, 우리의 서비스에 외부로 부터 입력되는 데이터는 다양한 형식을 가지고 있을 수 있습니다. 데이터가 xml 이나 json 형식으로 올 수도 있고, 요청되는 프로토콜도 Rest, RPC 방식등을 가지고 있을 수 있습니다.   

결국 이렇게 들어온 각종 데이터를 객체로 변환을 시켜야 하는 작업이 필요한데, 이러한 로직들을 도메인 영역에서. 처리를 한다면 (예를들어 객체 안쪽에서 변환작업 처리 등) 도메인 영역은 비대하여지고, 가독성이 떨어질 것 입니다. DDD 에서 말하는 잘 짜여진 코드는 '도메인을 보았을때 비지니스 흐름이 보여져야 한다.' 라고 말합니다. 가독성이 떨어지고 코드가 복잡해지면 결국 잘 짜여진 코드가 될수 없다는 말입니다.  

그리하여 나온 방법이 어뎁터를 사용하여 외부에서 들어오는 입력(input)과, 외부로 호출하려는 출력(output)을 처리하는 방식입니다. 어뎁터를 여러개 만들수 있는 구조를 가져서 상황에 맞는 어뎁터를 붙였다가 떼었다가 할수 있도록 구성합니다. 이러한 방법이 헥사고날 아키텍처의 핵심입니다.

그림을 좀더 살펴 보면, 가운데 노란색은 비지니스 영역입니다. 그리고 파란색 도형은 외부로부터의 입력을 컨트롤러 클레스를 이용하여 분리 하였습니다. 컨트롤러에서 변환작업이 있을 것입니다. 

하단에 데이터 베이스와의 연결도 어뎁터 패턴으로 분리를 합니다.예를 들어 데이터베이스에 종속적인 Query 를 직접 사용하였다면, 데이터베이스가 변경되는 상황이 발생할때 해당 로직은 모두 다시 만들어야 합니다. 

마찬가지로 메세지브로커를 사용하는 경우 특정 브로커(예: 카프카, RabbitMQ 등 )의 호출 코드를 직접적으로 사용하지 않고, 어뎁터 형식으로 사용하는 방법이 좋습니다.

이처럼 비지니스 로직은 순수한 형태로 구현을 하고, 그 이외의 것을 adapter 형식으로 설계를 하여 해당 비지니스 로직이 어느 환경에서도 잘 동작하도록 설계한 모형이 헥사고날 아키텍처이고, 마이크로 서비스 아키텍처에서는 이와 같은 방식을 지향합니다.



<div style="text-align: center;">

![스크린샷%202019-11-27%20오후%202](/img/03_Bizdevops/04/01/image88.png)

</div>

<br/>

### MSA Chassis

MSA Chassis 라는 말은 마이크로 서비스를 구축할때 필요한 프레임워크들의 모음입니다. 위에 설명한 헥사고날 아키텍처로 설계하여 비지니스 로직에 영향이 없는 개발을 맨땅에서 하려면 많은 공수가 필요합니다. 이에 많은 프레임워크들이 이와 같은 패턴들을 구성해 놓고 제공중입니다.

Java 계열에서 가장 선두주자인 Spring 프레임워크에서 마이크로 서비스에 적합한 spring-boot 프레임워크를 내어 놓았고, 이에 여러가지 어뎁터들에 해당하는 프로젝트들이 존재합니다. 아래 그림은 헥사고날 아키텍처에 spring-boot를 기반으로 한 MSA Chassis 를 입힌 모형입니다. Spring-Data-Rest 를 사용하여 Data 를 외부와 Rest 방식으로 연결시키고 , String-Cloud-Stream 으로 메세지 처리를 하는 로직을 구현하여 특정 브로커에 종속적이지 않은 adapter 패턴으로 구현된 모형입니다.

![스크린샷%202019-11-27%20오후%202](/img/03_Bizdevops/04/02/image89.png)

<br/>

---

<br/>

### Outer 아키텍처

마이크로서비스 아키텍처는 Inner와 Outer 로 구분하고 있으며, Outer 아키텍처는 가트너에서 6개의 서브 영역(아래 참조)으로 세분화하고 있습니다.

<div style="text-align: center;">

![가트너 MSA](/img/03_Bizdevops/07/01/image96.png)

</div>

<br/>

#### **API Gateway**

API Gateway는 마이크로서비스 외부로부터의 통합 접근을 위한 단일창구를 제공하며, 인증, 권한에 대한 통합 제어를 수행합니다.

#### **Service Mesh**

마이크로서비스의 네트워크 제어뿐만 아니라, 서비스간 Advanced한 호출 제어 및 트랜잭션을 관리 합니다.

#### **Container Management**

마이크로서비스를 물리적으로 적재하는 기반이며 논리적인 서비스 운영이 가능합니다. 컨테이너 기반의 대규모 마이크로서비스가 관리됩니다.

#### **Backing Services**

마이크로서비스에서 어플리케이션이 실행되는 가운데 네트워크를 통해서 사용할 수 있는 모든 서비스를 지칭합니다. 예를 들어 데이터베이스, 메시지/큐 시스템,  SMTP 서비스, 캐시 시스템이 있습니다.

#### **Telemetry**

마이크로서비스 아키텍처의 메트릭 기반 전 구간을 모니터링하며, 물리적으로 분산되어 운영되는 컨테이너 기반의 마이크로서비스에 대한 로그를 수집하고 서비스를 추적합니다.

#### **CI/CD Automation**

마이크로서비스의 소스Build에서부터 단위테스트와 컨트랙 테스트를 수행하는 Continuous Integration 영역과 도커 이미지를 생성해 운영 환경에 자동 배포되는 Continuous Deployment를 담당합니다.

<br/><br/>