## 마이크로 서비스간의 서열과 역학관계

마이크로 서비스들 간에는 서열이 존재한다.  이 서열로 인하여 시비스간의 통신 방법이나 리소스 할당 정책등을 정할 수 있다.

[1. 무엇을 우선적으로 챙길 것인가](#무엇을-우선적으로-챙길-것인가)  
[2. 어느 마이크로 서비스의 인터페이스를 더 중요하게 관리할 것인가?](#어느-마이크로-서비스의-인터페이스를-더-중요하게-관리할-것인가?)  
[3. 마이크로서비스간 트랜잭션의 묶음을 어떻게 할 것인가?](#마이크로서비스간-트랜잭션의-묶음을-어떻게-할-것인가?)  
[4. 무엇을 우선적으로 줄일 것인가?](#무엇을-우선적으로-줄일-것인가?)  

## **무엇을 우선적으로 챙길 것인가?**  

회사가 점점 커지면서 제공하는 서비스는 조금씩 많아 지게 되는데, 이럴때 마이크로 서비스의 서열을 체크하여 집중해야할 서비스를 결정 할 수 있다.  

회사에서 버릴수 없는 핵심 기능을 **Core Domain** 이라고 할 수 있다. 아마도 가장 처음에 회사를 생성하게된 핵심 비지니스 라고 할 수 있다. 쇼핑몰 시스템에서 주문, 카탈로그 서비스등 이 기능을 제공하지 않으면 회사가 망하는 도메인이다.  

기업의 핵심 경쟁력이 아닌, 직접 운영해도 좋지만 상황에 따라 아웃소싱 가능한 영역을 **Supportive Domain** 이라고 부를 수 있고, 이는 2순위로 회사에서 가져가야 할 영역이다. 쇼핑몰 시스템에서 재고관리, 배송, 회원관리 서비스 등이 이에 해당 된다. 예를 들어 배송서비스는 직접 운영을 한다면 배송상태를 직접 챙길수 있는 이점이 있지만, 경쟁 회사에서 배송을 더 잘한다면 차라리 외주를 주고, 코어 도메인에 더 집중을 하는게 경쟁력이 더욱 올라갈 것이다.   

서열의 마지막 순위로 다른 회사의 경쟁력이 너무 뛰어나서 오히려 만들면 손해가 나는 서비스가 있을 수 있다. 혹은 기업 경쟁력과 무관한 서비스가 있는데, 이를 **General Domain** 이라고 부른다. 이 영역은 가능하면 구현을 하지 말고, SaaS 서비스를 사용하거나 솔루션을 사는 방법이 더 비용을 아끼는 방법이 될 것이다. 쇼핑몰 시스템에서 결제, 빌링 서비스 등이 이 영역에 해당 할 수 있다. 예를들어 결제시스템을 직접 만든다면, 각종 카드사별 연동과, 지불 방법별 연동 등을 구축해야 하지만, 외부 서비스를 사용하면 PG 사 모듈만 심는 것으로 해결이 될 수 있다.

|  | 순위 | 예시 |
|---|:---:|:---:|
| ![Core](/img/03_Bizdevops/04/04/03_04_04_01.png) | 1순위 : Core Domain | 쇼핑몰 시스템에서 주문, 카탈로그 서비스|
| ![Supportive](/img/03_Bizdevops/04/04/03_04_04_02.png) | 2순위 : Supportive Domain | 재고관리, 배송, 회원관리 서비스 등|  
| ![General](/img/03_Bizdevops/04/04/03_04_04_03.png) | 3순위 : General Domain | 결제, 빌링 서비스 등 |


## **어느 마이크로 서비스의 인터페이스를 더 중요하게 관리할 것인가?**

![](/img/03_Bizdevops/04/04/03_04_04_04.png)  

서비스간의 서열에 따라서 인터페이스간의 역학관계가 생성된다.  

1. **Core Domain** 은 각 팀끼리 서비스가 분리 되어 있어도, 비슷한 개발 수준 역량을 가지고 있을 확률이 높다. 또한 핵심 기능을 분리한 경우일수도 있다. 코어 도메인간의 관계는 **Shared-Kernel** 도 허용이 가능하다. 쇼핑몰 시스템에서 주문과 상품 서비스가 예시가 될수있다. 두팀은 그정도 기술적 합의와 수준이 올라가 있는 상황이지만 KPI 는 달라서 서비스를 나눈 상황으로 볼 수 있다. 주문을 하기 위해서는 상품 정보가 필수로 필요하니 상품 도메인 클레스를 같이 공유하여 쓸 수 있다.    

> **Shared-Kernel** : 
> 두개의 MS 가 호출을 주고 받을때 필요한 도메인 클레스들을 라이브러리 형태로 공유하는것이다. 코드를 공유하고, 심지어 코드를 커밋할수있는 권한까지 공유 하기도 한다. 상당히 강한 파워를 가진 MS 끼리 허용될수 있다. 
> **Shared-Kernel** 을 Shared-Database 라고 생각하면 안된다.

2. **Core Domain** 과 **Supportive Domain** 간의 'interfacing' 은 **Conformist** 관계가 될 수 있다. 서비스들 끼리 인터페이스를 맞추려면 코드의 수정이 필요 할 수있는데, 높은 서열의 서비스가 중요도가 낮은 서비스를 위하여 자신의 코드를 수정해 가면서 인터페이스를 맞추는 경우는 없을 것이다.  

> **Conformist** : 
> 힘이 없기 때문에 업스트림에서 주는대로 쓰는 것이다. 업스트림의 api 가 바뀌면 다운스트림에서 알아서 바꿔야 하는 관계이다. 예를들어 facebook 의 api 를 사용하여 어플리케이션을 개발 한다고 치면, 특정 api 가 필요하다고 facebook 에 요청을 해도 들어주지가 않을 것이다.    

3. **Core Domain** 과 **General Domain**(외부서비스) 간의 관계는 **Anti-corruption Layer** 가 필요 할 수도 있다. 예를 들어 내부 시스템에서는 메세지 방식을 사용하는데 외부 시스템의 api 를 사용하기 위해서는 두 서비스의 통신방식을 해석하고 변환을 해주는 또 다른 서비스가 필요 할 것이다.  

> **Anti-corruption Layer** : 
> 두 시스템 간의 통신을 변환하여, 다른 응용 프로그램이 해당 디자인 및 기술 방식을 손상시키지 않도록 하여 해당 시스템을 변경되지 않은 상태로 유지하는 방식이다. 

## **마이크로서비스간 트랜잭션의 묶음을 어떻게 할 것인가?**

![](/img/03_Bizdevops/04/04/03_04_04_05.png)  

서비스간의 서열에 따라서 서로간의 트랜젝션 방식을 다르게 선택 할 수 있다. 

**Core Domain** 간에는 강결합을 사용하는 경우가 생긴다. 주문시 재고를 확인해야 하는 경우도 있을 수 있고, 재고가 없을 경우 주문이 안되는 식의 설계가 있을 수도 있다.
이럴때는 ACID Transaction 으로 두개의 서비스를 묶어 주고, 중요도에 따라서 2PC 방식으로 서비스와 통신이 되는지 확인이 필요 할 수도 있다.

**Core Domain** 과 서열이 낮은 서비스간의 통신은 강한 트렌젝션을 연결해야할 이유가 없다. 강 결합을 한다는 것은 항상 상대방 서비스가 정상작동을 해야 한다는 가정이 있다. 그러나 상품 추천이 안된다고 해서 핵심 비지니스인 주문을 안 받아서도 안되고, 배송기사가 없다고 해서 주문을 못 받아서도 안된다.  
**Core Domain** 과 **Supportive Domain**간 의 연결은 서로간의 서비스에 영향이 없도록 비동기 혹은 Event-Driven 방식으로 처리를 하는게 좋다. 혹은 상품 추천같이 자체적으로 UI 가 있는 경우 UI-MashUp 도 좋은 방법이다.      

## **무엇을 우선적으로 줄일 것인가**

![](/img/03_Bizdevops/04/04/03_04_04_06.png)  

쇼핑몰에서 이벤트를 실시할적에 순간적으로 사용자가 몰려서 서비스에 과부화가 걸리는 상황이 생길 수 있다. 이럴때 서비스를 스케일 아웃을 하여 해결을 하게 되는데, 리소스가 한정되어 있다면 **Core Domain** 을 확장하기 위하여 **Supportive Domain** 을 중지시킬 수 있다.  

쇼핑몰에서 배송 서비스는 주문이 폭주하는 시간에 배송 처리를 안하고, 야간에 서비스를 시작하여 처리를 해도 된다. 상품 추천 서비스도 주문이 폭주하여 장애가 일어나기 직전인 상황에서는 주문서비스를 살리기 위하여 리소스를 넘겨주는 선택을 할 수도 있다.  

<hr>

### 핵심 서비스인 주문 서비스가 죽었다면 배송처리와 상품추천은 의미가 없어진다. 또한 주문서비스와 배송서비스가 강결합으로 묶여있다면 서비스를 줄이는 선택은 할 수 없을 것이다. 이렇듯 각각의 마이크로 서비스 간에는 중요도에 따라 우선순위와 역학관계가 존재한다. 
