## 배포전략
마이크로 서비스 아키텍처 에서는 최소 하루에 1번 배포를 권장합니다. 그만큼 자주 배포를 하여 서비스의 안정도를 높이고, 변화하는 비지니스에 유연하게 대처 할 수 있습니다. 성공적인 비지니스를 위해서 다양한 배포 전략들이 사용 되고있습니다.

이번 장에서는 다양한 배포 전략들의 장단점 등을 살펴 보겠습니다.

* recreate : 이전버전 A가 종료 된 후 신규버전 B가 롤아웃됩니다.
* ramped (rolling-update) : 신규버전 B가 천천히 롤아웃되고 이전버전 A를 교체합니다.
* blue/green : 신규버전 B가 이전버전 A와 함께 배포 된 후 트래픽이 신규버전 B로 전환됩니다.
* canary : 신규버전 B가 일부 사용자에게 배포 된 후 전체 롤아웃으로 진행됩니다.
* A/B testing : 신규버전 B는 특정 조건에서 사용자의 하위 집합으로 배포 됩니다
* shadow : 신규버전 B는 이전버전 A와 함께 실제 트래픽을 수신하지만 응답에 영향을 미치지 않고 숨어있습니다.

![](/img/03_Bizdevops/06/deploystrategies.png)
> 이미지 참고 : https://blog.container-solutions.com/deployment-strategies

위 그림은 이후 설명할 배포 전략들을 요약해 놓은 표 입니다.  

#### recreate
recreate 단계는 무정지 배포단계가 아닙니다. 이전버전이 완전히 종료 된 후 신규 버전을 배포하는 방법입니다. 그리하여 종료 후 신규 배포 시간까지의 서비스 중단 시간이 있습니다.
* 장점
	- 가장 쉬운 배포 방법입니다.
	- 클라우드 리소스 비용이 적습니다.
* 단점
	- 서비스 중단 시간이 있어서 사용자에게 악영향을 미칩니다.

#### ramped (rolling-update) 
ramped 단계부터 무정지 배포입니다. 신규 버전을 한개씩 배포 시키고, 배포가 완료된 이전 버전을 한개씩 종료하는 방법입니다. 쿠버네티스의 기본 배포 방법입니다. 
* 장점
	- 다른 배포 방법에 비하여 비교적 쉬운 배포 방법입니다.
	- 클라우드 리소스 비용이 적습니다.
* 단점
	- 롤아웃, 롤백에 시간이 걸립니다.
	- 배포중 한쪽의 트래픽이 감소합니다. 처리 용량을 고민해야합니다.

#### blue/green 
신규버전(blue)을 완전히 배포한 후에 이전버전(green)에서 신규버전(blue)으로 트래픽을 변경하는 방법입니다. 즉 이전버전과 신규버전이 동시에 존재를 합니다. 
AWS 에서 10년 넘게 사용하여 안정화된 배포 전략 입니다.  
* 장점
	- 이전버전이 존재 하고있기때문에 즉시 롤백이 가능합니다.
	- 프로덕션 환경에 영향을 주지 않고, 실제 서비스 환경에서 신규 버전 테스트가 가능합니다.
* 단점
	- 두배로 자원이 들어갑니다.

#### canary
신규 버전을 일부 사용자에게 노출하거나, 특정 기간에 걸쳐서 서서히 신규 버전을 노출 시키는 방법입니다. canary 라는 말은 카나리아 새에서 그 어원이 있습니다. 그 어원은 탄광개발을 시작할때, 탄광을 폭파 후 카나리아 새를 탄광으로 보낸 후 카나리아가 울면 사람도 들어갈수 있는 환경이고, 카나리아 울음소리가 들리지 않으면 사람이 들어갈수 없는 환경이라고 판단을 하였습니다. 즉, 최소한의 희생으로 신규 버전의 안정성을 확인 하는 방법입니다.  
페이스북은 신규 버전이 나왔을때 페이스북 직원에게 먼저 노출을 시킨다고 합니다. 일정기간동안 사내 직원이 사용해 보고 오류사항등을 빠르게 파악하여 수정하는 방법을 사용합니다. 
* 장점
	- 오류 수정 및 모니터링에 유리합니다.
	- 빠른 롤백이 가능합니다.
* 단점
	- 배포 즉 롤아웃에 시간이 걸립니다.

#### A/B testing 
일반적인 배포 전략이 아닌 통계를 기반으로 비지니스 의사 결정을 내리는 기술입니다. 의학 계열에서 신약 테스트를 할때 나이별, 지역별, 성별 등으로 군집을 나누어서 결과값을 측정할때 사용하는 기술입니다. 즉 특정 사용자에게 다른 버전을 배포 한 후 트래픽 증가나, 버튼 클릭수, 인기도 등을 판단할때 사용하는 기술입니다. 실제 배포 방법은 카나리 배포로 이루어 집니다.
* 장점
	- 실제 유저를 타겟팅하여 테스트 결과를 추출 할 수 있습니다.
* 단점
	- 지능형 로드벨런서가 필요합니다.
	- 오류가 발생시 분산 추적기술이 필요합니다.
	- 설정이 가장 어려운 방법중에 하나입니다.

#### shadow 
가장 소심한 배포 방법입니다. 신규버전은 이전 버전과 같은 프로덕션 환경에 배포가 되어 트래픽을 같이 받습니다. 그렇지만 실제로 응답을 하지는 않고 로그등으로 신규 시스템의 안정성을 테스트 하는 배포 방법입니다. 그 후 안정성이 확보 된다면 롤아웃 시킵니다. 안정성을 확보 할 수 있는 좋은 배포 방법이지만, 신규 버전이 응답을 하지 않기 위해서는 설정이 매우 복잡한게 큰 단점입니다.
숨겨서 배포 된다는 의미로 Mirroring Traffic, Dark Launch 라고도 불리웁니다.
* 장점
	- 사용자에게 영향을 미치지 않습니다.
	- 성능 테스트, 안정성 테스트에 유용합니다.
* 단점
	- 설정이 매우 복잡합니다.
	- 두배의 자원이 필요합니다.
	- 실제 사용자 테스트가 아니기 때문에 잘못된 판단을 내릴수 있습니다.

<br/>

## 요약하자면
다양한 배포 전략이 있지만, 요구사항과 예산, 그리고 전략 구현 여부에 따라서 배포 전략이 달라집니다. 예를들어 쉐도우 배포 방법을 어설프게 사용하면 크나큰 혼란이 있을 수 있습니다.  

* recreate 방법은 서비스 중단시간이 있기 때문에 사용이 불가능합니다.
* 개발/스테이징 배포는 특별한 설정이 필요없는 ramped 방법이 좋습니다.
* 프로덕션 환경 배포는 ramped 나 blue/green 배포가 일반적입니다. (두 배포 방법은 쿠버네티스에서 기본적으로 설정이 가능합니다.)
* 안정성에 대한 확신이 거의없는 경우 카나리아, A/B 테스트 또는 섀도우 배포 방법을 사용 할 수 있습니다. 다만 이 세가지 방법은 트래픽을 컨트롤 하는 방법이라 특정 CD 툴을 사용하거나 쿠버네티스 환경이라면 istio 등을 사용하여야 합니다.
* 섀도우 배포 방법은 호출시 쉐도우로 호출시 데이터베이스에 저장이 안되는 등의 특별한 추가 작업이 필요합니다. istio 설정만으로 해결이 안됩니다.

<br/>

